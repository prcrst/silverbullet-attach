var mod=(()=>{var g=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var m=(e,t)=>{for(var o in t)g(e,o,{get:t[o],enumerable:!0})},$=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of R(t))!K.call(e,i)&&i!==o&&g(e,i,{get:()=>t[i],enumerable:!(r=N(t,i))||r.enumerable});return e};var O=e=>$(g({},"__esModule",{value:!0}),e);var tt={};m(tt,{functionMapping:()=>E});typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var h=new Map,y=0;function f(e){self.postMessage(e)}self.syscall=async(e,...t)=>await new Promise((o,r)=>{y++,h.set(y,{resolve:o,reject:r}),f({type:"sys",id:y,name:e,args:t})});function v(e,t){self.addEventListener("message",o=>{(async()=>{let r=o.data;switch(r.type){case"inv":{let i=e[r.name];if(!i)throw new Error(`Function not loaded: ${r.name}`);try{let s=await Promise.resolve(i(...r.args||[]));f({type:"invr",id:r.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",r.name,"error:",s),f({type:"invr",id:r.id,error:s.message})}}break;case"sysr":{let i=r.id,s=h.get(i);if(!s)throw Error("Invalid request id");h.delete(i),r.error?s.reject(new Error(r.error)):s.resolve(r.result)}break}})().catch(console.error)}),f({type:"manifest",manifest:t})}function q(e){let t=atob(e),o=t.length,r=new Uint8Array(o);for(let i=0;i<o;i++)r[i]=t.charCodeAt(i);return r}function A(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",o=e.byteLength;for(let r=0;r<o;r++)t+=String.fromCharCode(e[r]);return btoa(t)}async function B(e,t){if(typeof e!="string"){let o=new Uint8Array(await e.arrayBuffer()),r=o.length>0?A(o):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:r},e=e.url}return syscall("sandboxFetch.fetch",e,t)}function L(){globalThis.nativeFetch=globalThis.fetch,globalThis.fetch=async function(e,t){let o=t&&t.body?A(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,r=await B(e,t&&{method:t.method,headers:t.headers,base64Body:o});return new Response(r.base64Body?q(r.base64Body):null,{status:r.status,headers:r.headers})}}L();var a={};m(a,{confirm:()=>ue,dispatch:()=>le,downloadFile:()=>Z,filterBox:()=>re,flashNotification:()=>te,fold:()=>ge,foldAll:()=>xe,getCurrentPage:()=>Y,getCursor:()=>j,getSelection:()=>G,getText:()=>W,getUiOption:()=>de,hidePanel:()=>oe,insertAtCursor:()=>ce,insertAtPos:()=>ie,moveCursor:()=>se,navigate:()=>H,openUrl:()=>X,prompt:()=>me,reloadPage:()=>z,reloadUI:()=>J,replaceRange:()=>ae,save:()=>V,setPage:()=>Q,setSelection:()=>_,setUiOption:()=>fe,showPanel:()=>ne,toggleFold:()=>he,unfold:()=>ye,unfoldAll:()=>Pe,uploadFile:()=>ee,vimEx:()=>pe});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var n=self.syscall;function Y(){return n("editor.getCurrentPage")}function Q(e){return n("editor.setPage",e)}function W(){return n("editor.getText")}function j(){return n("editor.getCursor")}function G(){return n("editor.getSelection")}function _(e,t){return n("editor.setSelection",e,t)}function V(){return n("editor.save")}function H(e,t,o=!1,r=!1){return n("editor.navigate",e,t,o,r)}function z(){return n("editor.reloadPage")}function J(){return n("editor.reloadUI")}function X(e,t=!1){return n("editor.openUrl",e,t)}function Z(e,t){return n("editor.downloadFile",e,t)}function ee(e,t){return n("editor.uploadFile",e,t)}function te(e,t="info"){return n("editor.flashNotification",e,t)}function re(e,t,o="",r=""){return n("editor.filterBox",e,t,o,r)}function ne(e,t,o,r=""){return n("editor.showPanel",e,t,o,r)}function oe(e){return n("editor.hidePanel",e)}function ie(e,t){return n("editor.insertAtPos",e,t)}function ae(e,t,o){return n("editor.replaceRange",e,t,o)}function se(e,t=!1){return n("editor.moveCursor",e,t)}function ce(e){return n("editor.insertAtCursor",e)}function le(e){return n("editor.dispatch",e)}function me(e,t=""){return n("editor.prompt",e,t)}function ue(e){return n("editor.confirm",e)}function de(e){return n("editor.getUiOption",e)}function fe(e,t){return n("editor.setUiOption",e,t)}function pe(e){return n("editor.vimEx",e)}function ge(){return n("editor.fold")}function ye(){return n("editor.unfold")}function he(){return n("editor.toggleFold")}function xe(){return n("editor.foldAll")}function Pe(){return n("editor.unfoldAll")}var p={};m(p,{parseMarkdown:()=>we});function we(e){return n("markdown.parseMarkdown",e)}var c={};m(c,{deleteAttachment:()=>ke,deleteFile:()=>Ke,deletePage:()=>Ce,getAttachmentMeta:()=>Me,getFileMeta:()=>Ne,getPageMeta:()=>be,listAttachments:()=>Ie,listFiles:()=>Ue,listPages:()=>Te,listPlugs:()=>Se,readAttachment:()=>Fe,readFile:()=>Ee,readPage:()=>ve,writeAttachment:()=>De,writeFile:()=>Re,writePage:()=>Ae});function Te(e=!1){return n("space.listPages",e)}function be(e){return n("space.getPageMeta",e)}function ve(e){return n("space.readPage",e)}function Ae(e,t){return n("space.writePage",e,t)}function Ce(e){return n("space.deletePage",e)}function Se(){return n("space.listPlugs")}function Ie(){return n("space.listAttachments")}function Me(e){return n("space.getAttachmentMeta",e)}function Fe(e){return n("space.readAttachment",e)}function De(e,t){return n("space.writeAttachment",e,t)}function ke(e){return n("space.deleteAttachment",e)}function Ue(){return n("space.listFiles")}function Ee(e){return n("space.readFile",e)}function Ne(e){return n("space.getFileMeta",e)}function Re(e,t){return n("space.writeFile",e,t)}function Ke(e){return n("space.deleteFile",e)}function x(e,t){if(t(e))return[e];let o=[];if(e.children)for(let r of e.children)o=[...o,...x(r,t)];return o}function P(e,t){return x(e,o=>o.type===t)[0]}function C(e,t){x(e,t)}var l=globalThis.syscall;var u={};m(u,{parse:()=>_e,stringify:()=>Ve});function _e(e){return l("yaml.parse",e)}function Ve(e){return l("yaml.stringify",e)}async function Je(e,t){let o=await c.readPage(e),r=await p.parseMarkdown(o),i;return C(r,s=>{if(s.type!=="FencedCode")return!1;let T=P(s,"CodeInfo");if(t&&!T||t&&!t.includes(T.children[0].text))return!1;let b=P(s,"CodeText");return b?(i=b.children[0].text,!0):!1}),i}async function S(e,t=["yaml"]){let o=await Je(e,t);if(o!==void 0)try{return u.parse(o)}catch(r){throw console.error("YAML Page parser error",r),new Error(`YAML Error: ${r.message}`)}}var Xe="SETTINGS";async function d(e){try{let t=await S(Xe,["yaml"])||{},o={};for(let[r,i]of Object.entries(e))r in t?o[r]=t[r]:o[r]=i;return o}catch(t){if(t.message==="Not found")return e;throw t}}function I(e){function t(o){let r=String(o);return r.length===1&&(r="0"+r),r}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())}async function M(e=null,t=null){let{attachImagePrefix:o}=await d({attachImagePrefix:"images"});e??=o;let r=await a.uploadFile("image/*",t),i=await a.prompt("Name:",`${e}/${r.name}`);i&&(await c.writeAttachment(i,r.content),await a.insertAtCursor(`![](${i})`))}async function w(){let{cameraImagePrefix:e}=await d({cameraImagePrefix:"images/camera"});await M(e,"environment")}async function F(){let{dailyImagePrefix:e}=await d({dailyImagePrefix:"images/daily"}),t=await a.uploadFile("image/*"),o=t.name.split(".").pop(),r=await a.prompt("Daily image name:",`${e}/${I(new Date)}.${o}`);r&&(await c.writeAttachment(r,t.content),await a.insertAtCursor(`![](${r})`))}async function Ze(e=null,t=null){let{attachImagePrefix:o}=await d({attachImagePrefix:"images"});e??=o;let r=await a.uploadFile("image/*",t),i=`${e}/${r.name}`;await c.writeAttachment(i,r.content),await a.insertAtCursor(`![](${i})`)}async function D(e){M()}async function k(e){w()}async function U(e){let t=await a.getCurrentPage();Ze(t)}var E={attachDailyImage:F,attachCameraImage:w,insertImage:D,insertCameraImage:k,insertRelativeImage:U},et={name:"attach",functions:{attachDailyImage:{path:"attach.ts:attachDailyImage",command:{name:"Attach: Daily image"}},attachCameraImage:{path:"attach.ts:attachCameraImage",command:{name:"Attach: Camera image"}},insertImage:{path:"attach.ts:insertImage",slashCommand:{name:"attach",description:"Attach an image"}},insertCameraImage:{path:"attach.ts:insertCameraImage",slashCommand:{name:"camera",description:"Attach an image from the device camera"}},insertRelativeImage:{path:"attach.ts:insertImageRelative",slashCommand:{name:"attachHere",description:"Attach an image and save according to the page path"}}},assets:{}};v(E,et);return O(tt);})();
